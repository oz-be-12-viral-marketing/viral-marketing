{% extends 'base.html' %}

{% block title %}소비 리포트{% endblock %}

{% block content %}
<div class="container mt-5 animate__animated animate__fadeInUp">
    <h2 class="mb-4 text-center fw-bold">소비 리포트</h2>

    <div class="row mb-5 justify-content-center">
        <div class="col-md-5 mb-4">
            <div class="card shadow-lg h-100">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title text-center mb-3 fw-bold">주간 소비 분석</h5>
                    <p class="card-text text-muted text-center">최근 주간 소비 패턴을 카테고리별로 분석합니다.</p>
                    <div style="height: 250px; position: relative;" class="mb-3">
                        <canvas id="weekly-spending-chart"></canvas>
                    </div>
                    <div class="d-grid gap-2 mt-auto">
                        <button class="btn btn-primary btn-lg w-100" id="generate-weekly-report">주간 리포트 생성</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-5 mb-4">
            <div class="card shadow-lg h-100">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title text-center mb-3 fw-bold">월간 소비 분석</h5>
                    <p class="card-text text-muted text-center">최근 월간 소비 패턴을 카테고리별로 분석합니다.</p>
                    <div style="height: 250px; position: relative;" class="mb-3">
                        <canvas id="monthly-spending-chart"></canvas>
                    </div>
                    <div class="d-grid gap-2 mt-auto">
                        <button class="btn btn-success btn-lg w-100" id="generate-monthly-report">월간 리포트 생성</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <h3 class="mb-3 fw-bold">생성된 리포트 목록</h3>
    <div id="report-list" class="row">
        <!-- 리포트 목록이 여기에 동적으로 로드됩니다. -->
        <div class="col-12">
            <p class="text-muted text-center">생성된 리포트가 없습니다.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const weeklyBtn = document.getElementById('generate-weekly-report');
    const monthlyBtn = document.getElementById('generate-monthly-report');
    const weeklyChartCanvas = document.getElementById('weekly-spending-chart');
    const monthlyChartCanvas = document.getElementById('monthly-spending-chart');
    const reportListDiv = document.getElementById('report-list');

    let weeklyChart = null;
    let monthlyChart = null;

    // Define a more vibrant and accessible color palette
    const backgroundColors = [
        '#FF6384', // Red
        '#36A2EB', // Blue
        '#FFCE56', // Yellow
        '#4BC0C0', // Teal
        '#9966FF', // Purple
        '#FF9F40', // Orange
        '#8D8D8D', // Grey
        '#C70039', // Dark Red
        '#581845', // Dark Purple
        '#DAF7A6'  // Light Green
    ];
    const borderColors = [
        '#FF6384',
        '#36A2EB',
        '#FFCE56',
        '#4BC0C0',
        '#9966FF',
        '#FF9F40',
        '#8D8D8D',
        '#C70039',
        '#581845',
        '#DAF7A6'
    ];

    // 그래프를 그리는 함수
    function drawChart(canvasElement, chartData, title) {
        if (canvasElement.chart) {
            canvasElement.chart.destroy();
        }

        const ctx = canvasElement.getContext('2d');
        canvasElement.chart = new Chart(ctx, {
            type: 'doughnut', // 도넛 차트
            data: {
                labels: chartData.categories,
                datasets: [{
                    label: '총 금액',
                    data: chartData.spending,
                    backgroundColor: backgroundColors.slice(0, chartData.categories.length),
                    borderColor: '#ffffff', // White border for slices
                    borderWidth: 2,
                    hoverOffset: 8 // Enhanced hover effect
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%', // 도넛 두께
                plugins: {
                    title: {
                        display: true,
                        text: title,
                        font: {
                            size: 18,
                            weight: 'bold'
                        },
                        color: '#333'
                    },
                    legend: {
                        position: 'right',
                        labels: {
                            color: '#333',
                            font: {
                                size: 14
                            },
                            boxWidth: 20, // Larger color boxes
                            padding: 10 // More padding between legend items
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed !== null) {
                                    label += '₩' + new Intl.NumberFormat().format(context.parsed);
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

    // 리포트 생성 버튼 클릭 이벤트 (Celery 태스크 호출)
    async function generateReport(periodType) {
        try {
            const response = await fetch(`/api/v1/analysis/generate-report/${periodType}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin'
            });
            const data = await response.json();
            if (response.ok) {
                alert(`${periodType === 'weekly' ? '주간' : '월간'} 리포트 생성을 요청했습니다. 잠시 후 새로고침 해주세요.`);
                fetchReportList();
            } else {
                alert(`리포트 생성 실패: ${data.error || response.statusText}`);
            }
        } catch (error) {
            console.error('리포트 생성 요청 중 오류 발생:', error);
            alert('리포트 생성 요청 중 오류가 발생했습니다.');
        }
    }

    if (weeklyBtn) {
        weeklyBtn.addEventListener('click', () => generateReport('weekly'));
    }
    if (monthlyBtn) {
        monthlyBtn.addEventListener('click', () => generateReport('monthly'));
    }

    // 생성된 리포트 목록을 가져오는 함수
    async function fetchReportList() {
        try {
            const response = await fetch('/api/v1/analysis/reports/', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin'
            });
            const data = await response.json();
            reportListDiv.innerHTML = '';
            if (data.reports && data.reports.length > 0) {
                // 최신 리포트 데이터를 찾아 그래프 그리기
                const latestWeeklyReport = data.reports.find(report => report.report_type === 'weekly');
                const latestMonthlyReport = data.reports.find(report => report.report_type === 'monthly');

                if (latestWeeklyReport && latestWeeklyReport.json_data) {
                    const chartData = latestWeeklyReport.json_data;
                    // Ensure categories are translated if they are still raw values (should be handled by backend now)
                    // const translatedCategories = chartData.categories.map(cat => {
                    //     const categoryMap = { 'FOOD': '식비', 'TRANSPORTATION': '교통', 'SHOPPING': '쇼핑', 'HOUSING': '주거', 'UTILITIES': '공과금', 'ENTERTAINMENT': '문화/여가', 'HEALTH': '건강/의료', 'EDUCATION': '교육', 'FINANCE': '금융', 'OTHER': '기타', 'INCOME': '수입' };
                    //     return categoryMap[cat] || cat;
                    // });
                    drawChart(weeklyChartCanvas, chartData, `주간 소비 리포트 (${latestWeeklyReport.generated_date})`);
                } else {
                    weeklyChartCanvas.style.display = 'none';
                    weeklyChartCanvas.insertAdjacentHTML('afterend', '<p class="text-muted text-center">주간 리포트 데이터가 없습니다.</p>');
                }

                if (latestMonthlyReport && latestMonthlyReport.json_data) {
                    const chartData = latestMonthlyReport.json_data;
                    // const translatedCategories = chartData.categories.map(cat => {
                    //     const categoryMap = { 'FOOD': '식비', 'TRANSPORTATION': '교통', 'SHOPPING', 'HOUSING', 'UTILITIES', 'ENTERTAINMENT', 'HEALTH', 'EDUCATION', 'FINANCE', 'OTHER', 'INCOME' };
                    //     return categoryMap[cat] || cat;
                    // });
                    drawChart(monthlyChartCanvas, chartData, `월간 소비 리포트 (${latestMonthlyReport.generated_date})`);
                } else {
                    monthlyChartCanvas.style.display = 'none';
                    monthlyChartCanvas.insertAdjacentHTML('afterend', '<p class="text-muted text-center">월간 리포트 데이터가 없습니다.</p>');
                }

                // 리포트 목록 표시
                data.reports.forEach(report => {
                    const reportItem = document.createElement('div');
                    reportItem.className = 'col-md-6 mb-3'; // Use Bootstrap grid for list items
                    reportItem.innerHTML = `
                        <div class="card shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title fw-bold">
                                    ${report.report_type === 'weekly' ? '주간 소비 리포트' : '월간 소비 리포트'}
                                </h5>
                                <p class="card-text text-muted">생성일: ${new Date(report.generated_date).toLocaleDateString('ko-KR')}</p>
                                <button class="btn btn-sm btn-info view-report-btn mt-2" data-report-id="${report.id}" data-report-type="${report.report_type}">리포트 보기</button>
                            </div>
                        </div>
                    `;
                    reportListDiv.appendChild(reportItem);
                });

                // "리포트 보기" 버튼 클릭 이벤트 리스너 추가
                reportListDiv.querySelectorAll('.view-report-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const reportId = this.dataset.reportId;
                        const reportType = this.dataset.reportType;
                        const selectedReport = data.reports.find(r => r.id == reportId);
                        if (selectedReport && selectedReport.json_data) {
                            const chartData = selectedReport.json_data;
                            if (reportType === 'weekly') {
                                weeklyChartCanvas.style.display = 'block';
                                monthlyChartCanvas.style.display = 'none';
                                drawChart(weeklyChartCanvas, chartData, `주간 소비 리포트 (${selectedReport.generated_date})`);
                            } else {
                                monthlyChartCanvas.style.display = 'block';
                                weeklyChartCanvas.style.display = 'none';
                                drawChart(monthlyChartCanvas, chartData, `월간 소비 리포트 (${selectedReport.generated_date})`);
                            }
                        }
                    });
                });

            } else {
                reportListDiv.innerHTML = '<div class="col-12"><p class="text-muted text-center">생성된 리포트가 없습니다.</p></div>';
                weeklyChartCanvas.style.display = 'none';
                monthlyChartCanvas.style.display = 'none';
                weeklyChartCanvas.insertAdjacentHTML('afterend', '<p class="text-muted text-center">주간 리포트 데이터가 없습니다.</p>');
                monthlyChartCanvas.insertAdjacentHTML('afterend', '<p class="text-muted text-center">월간 리포트 데이터가 없습니다.</p>');
            }
        } catch (error) {
            console.error('리포트 목록을 가져오는 중 오류 발생:', error);
            reportListDiv.innerHTML = '<div class="col-12"><p class="text-danger text-center">리포트 목록을 불러올 수 없습니다.</p></div>';
            weeklyChartCanvas.style.display = 'none';
            monthlyChartCanvas.style.display = 'none';
            weeklyChartCanvas.insertAdjacentHTML('afterend', '<p class="text-danger text-center">리포트 데이터를 불러올 수 없습니다.</p>');
            monthlyChartCanvas.insertAdjacentHTML('afterend', '<p class="text-danger text-center">리포트 데이터를 불러올 수 없습니다.</p>');
        }
    }

    // 페이지 로드 시 리포트 목록 가져오기
    fetchReportList();
});
</script>
{% endblock %}