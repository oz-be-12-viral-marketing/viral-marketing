{% extends 'base.html' %}

{% block title %}감정 분석 테스트{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2>소비자 감정 분석</h2>
    <p>분석하고 싶은 문장을 아래에 입력하세요.</p>

    <form id="sentiment-form">
        {% csrf_token %}
        <div class="mb-3">
            <textarea class="form-control" id="text-content" rows="5" placeholder="예: 이 제품은 정말 환상적이에요! 가격도 저렴하고 품질도 좋습니다." required></textarea>
        </div>
        <button type="submit" class="btn btn-primary">분석하기</button>
    </form>

    <div id="result-container" class="mt-4" style="display: none;">
        <h4>분석 결과</h4>
        <div class="card">
            <div class="card-body">
                <p><strong>감정:</strong> <span id="result-sentiment"></span></p>
                <p><strong>점수:</strong> <span id="result-score"></span></p>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('sentiment-form').addEventListener('submit', function(event) {
    event.preventDefault();

    const textContent = document.getElementById('text-content').value;
    const resultContainer = document.getElementById('result-container');
    const resultSentiment = document.getElementById('result-sentiment');
    const resultScore = document.getElementById('result-score');

    // CSRF 토큰 가져오기
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    fetch('/api/v1/analysis/sentiment/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ text_content: textContent })
    })
    .then(response => response.json())
    .then(data => {
        if (data.sentiment) {
            let emoji = '';
            if (data.sentiment === '긍정') {
                emoji = '😃';
            } else if (data.sentiment === '부정') {
                emoji = '😠';
            }

            const confidence = (data.score * 100).toFixed(2) + '%';

            resultSentiment.innerHTML = `${emoji} ${data.sentiment}`;
            resultScore.textContent = `신뢰도: ${confidence}`;
            resultContainer.style.display = 'block';
        } else {
            console.error('Error:', data.error);
            alert('분석 중 오류가 발생했습니다: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Fetch Error:', error);
        alert('서버와 통신 중 오류가 발생했습니다.');
    });
});
</script>
{% endblock %}
