{% extends 'base.html' %}

{% block title %}ê°ì • ë¶„ì„ í…ŒìŠ¤íŠ¸{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2>ì†Œë¹„ì ê°ì • ë¶„ì„</h2>
    <p>ë¶„ì„í•˜ê³  ì‹¶ì€ ë¬¸ì¥ì„ ì•„ë˜ì— ì…ë ¥í•˜ì„¸ìš”.</p>

    <form id="sentiment-form">
        {% csrf_token %}
        <div class="mb-3">
            <textarea class="form-control" id="text-content" rows="5" placeholder="ì˜ˆ: ì´ ì œí’ˆì€ ì •ë§ í™˜ìƒì ì´ì—ìš”! ê°€ê²©ë„ ì €ë ´í•˜ê³  í’ˆì§ˆë„ ì¢‹ìŠµë‹ˆë‹¤." required></textarea>
        </div>
        <button type="submit" class="btn btn-primary">ë¶„ì„í•˜ê¸°</button>
    </form>

    <div id="result-container" class="mt-4" style="display: none;">
        <h4>ë¶„ì„ ê²°ê³¼</h4>
        <div class="card">
            <div class="card-body">
                <p><strong>ê°ì •:</strong> <span id="result-sentiment"></span></p>
                <p><strong>ì ìˆ˜:</strong> <span id="result-score"></span></p>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('sentiment-form').addEventListener('submit', function(event) {
    event.preventDefault();

    const textContent = document.getElementById('text-content').value;
    const resultContainer = document.getElementById('result-container');
    const resultSentiment = document.getElementById('result-sentiment');
    const resultScore = document.getElementById('result-score');

    // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    fetch('/api/v1/analysis/sentiment/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ text_content: textContent })
    })
    .then(response => response.json())
    .then(data => {
        if (data.sentiment) {
            let emoji = '';
            if (data.sentiment === 'ê¸ì •') {
                emoji = 'ğŸ˜ƒ';
            } else if (data.sentiment === 'ë¶€ì •') {
                emoji = 'ğŸ˜ ';
            }

            const confidence = (data.score * 100).toFixed(2) + '%';

            resultSentiment.innerHTML = `${emoji} ${data.sentiment}`;
            resultScore.textContent = `ì‹ ë¢°ë„: ${confidence}`;
            resultContainer.style.display = 'block';
        } else {
            console.error('Error:', data.error);
            alert('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Fetch Error:', error);
        alert('ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
});
</script>
{% endblock %}
