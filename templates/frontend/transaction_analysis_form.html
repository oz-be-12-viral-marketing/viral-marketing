{% extends 'base.html' %}
{% load humanize %}

{% block title %}거래 내역 감정 분석{% endblock %}

{% block content %}
<div class="container mt-5 animate__animated animate__fadeInUp">
    <h2>거래 내역 리뷰 및 감정 분석</h2>
    <p>선택하신 거래 내역에 대한 경험을 리뷰하고 감정을 분석해보세요.</p>

    <div class="card mb-4">
        <div class="card-header">
            분석할 거래 내역
        </div>
        <div class="card-body">
            <h5 class="card-title">{{ transaction.transaction_detail }}</h5>
            <p class="card-text">
                <strong>거래 일시:</strong> {{ transaction.created_at|date:"Y년 m월 d일 H:i" }}<br>
                <strong>거래 종류:</strong> {{ transaction.get_transaction_type_display }}<br>
                <strong>금액:</strong> ₩ {{ transaction.amount|floatformat:0|intcomma }}
            </p>
        </div>
    </div>

    <form id="sentiment-form">
        <div class="mb-3">
            <label for="text-content" class="form-label"><strong>리뷰 작성</strong></label>
            <textarea class="form-control" id="text-content" rows="5" placeholder="예: 이 식당 음식은 정말 맛있었어요!" required></textarea>
        </div>
        <button type="submit" class="btn btn-primary">분석하기</button>
        <a href="{% url 'transactions_list' %}" class="btn btn-secondary">목록으로 돌아가기</a>
    </form>

    <div id="result-container" class="mt-4" style="display: none;">
        <h4>분석 결과</h4>
        <div class="card">
            <div class="card-body">
                <p><strong>감정:</strong> <span id="result-sentiment"></span></p>
                <p><strong>점수:</strong> <span id="result-score"></span></p>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('sentiment-form').addEventListener('submit', function(event) {
    event.preventDefault();

    const textContent = document.getElementById('text-content').value;
    const transactionId = {{ transaction.id }};
    const resultContainer = document.getElementById('result-container');
    const resultSentiment = document.getElementById('result-sentiment');
    const resultScore = document.getElementById('result-score');
    const submitButton = event.target.querySelector('button[type="submit"]');

    // Disable button and show loading text
    submitButton.disabled = true;
    submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 분석 중...';

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    fetch(`/api/v1/analysis/transactions/${transactionId}/sentiment/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ text_content: textContent })
    })
    .then(response => {
        if (!response.ok) {
            // Handle non-2xx responses by reading the error message
            return response.json().then(err => { throw new Error(err.error || '알 수 없는 오류가 발생했습니다.') });
        }
        return response.json();
    })
    .then(data => {
        // On success, redirect to the analysis history page
        window.location.href = "{% url 'analysis_history' %}";
    })
    .catch(error => {
        console.error('Fetch Error:', error);
        alert('분석 중 오류가 발생했습니다: ' + error.message);
    })
    .finally(() => {
        // Re-enable button and restore text
        submitButton.disabled = false;
        submitButton.innerHTML = '분석하기';
    });
});
</script>
{% endblock %}
